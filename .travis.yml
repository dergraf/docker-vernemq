sudo: 'required'
services:
  - 'docker'
stages:
  - name: test
  - name: push-latest
    if: (type != pull_request) AND (branch = master)
  - name: push-tag
    if: (type != pull_request) AND (tag IS present) AND (branch = master)

env:
  - DOCKERFILE=Dockerfile TARGET=rel TAG_SUFFIX=""
  - DOCKERFILE=Dockerfile.alpine TARGET=rel TAG_SUFFIX="-alpine"
#  - DOCKERFILE=Dockerfile TARGET=swc TAG_SUFFIX="-swc"
#  - DOCKERFILE=Dockerfile.alpine TARGET=swc TAG_SUFFIX="-swc-alpine"

matrix:
  fast_finish: true

before_install:
  - |
    if [[ ${TRAVIS_PULL_REQUEST} == "false" ]]; then
       export GIT_SLUG="vernemq/vernemq"
       export GIT_BRANCH="master"
    else
       export GIT_SLUG=${TRAVIS_PULL_REQUEST_SLUG}
       export GIT_BRANCH=${TRAVIS_PULL_REQUEST_BRANCH}
    fi
  - docker build --build-arg TARGET=${TARGET}
                 --build-arg VERNEMQ_REPO=https://github.com/${GIT_SLUG}
                 --build-arg VERNEMQ_GIT_REF=${GIT_BRANCH}
                 -t vmq-travis
                 -f ${DOCKERFILE} .

jobs:
  include:
    - stage: test
      script: docker run vmq-travis vernemq

    - stage: push-latest
      script: docker tag vmq-travis vernemq/vernemq:latest$TAG_SUFFIX

    - stage: push-tag
      script: docker tag vmq-travis vernemq/vernemq:$TRAVIS_TAG$TAG_SUFFIX
